// --- เรียกผู้ช่วย (Libraries) ---
// เราต้องเรียกผู้ช่วย 2 ตัวเข้ามาในโปรเจกต์นี้
// 1. OneWire: เป็นเหมือน "ล่าม" ที่เข้าใจ "ภาษา" การสื่อสารแบบสายเส้นเดียว
// 2. DallasTemperature: เป็น "ผู้เชี่ยวชาญ" ที่รู้วิธีคุยกับเซ็นเซอร์ "เรื่องอุณหภูมิ" โดยเฉพาะ
#include <OneWire.h>
#include <DallasTemperature.h>

// --- ตั้งค่าฮาร์ดแวร์ ---
// กำหนด "บ้านเลขที่" หรือก็คือขาบนบอร์ด Arduino ที่เราต่อสาย DATA ของเซ็นเซอร์ไว้
// ถ้าเราเปลี่ยนไปเสียบขาอื่น ก็ต้องมาแก้เลขตรงนี้ด้วยนะ
#define ONE_WIRE_BUS 32
const float alpha =  1.0444 ; // Slope from Excel 
const float beta = -1.3354; // Offset from Excel 

// --- เตรียมเครื่องมือให้พร้อมทำงาน ---S
// สร้าง "ตัวละคร" ขึ้นมา 2 ตัว
// 1. oneWire: จะเป็นคนคุมการสื่อสารบนขาที่เราเพิ่งกำหนดไป
// 2. sensors: คือผู้เชี่ยวชาญด้านอุณหภูมิ ที่เราสั่งให้ไปทำงานผ่าน oneWire อีกที
OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensors(&oneWire);


// ฟังก์ชัน setup() จะทำงานแค่ "ครั้งเดียว" ตอนเปิดเครื่องหรือกดรีเซ็ต
void setup() {
  // เปิดหน้าต่างแชท (Serial Monitor) ที่ความเร็ว 9600 เพื่อให้เราดูผลลัพธ์บนคอมพิวเตอร์ได้
  Serial.begin(9600);
  
  // สั่งให้ผู้เชี่ยวชาญของเรา (sensors) เริ่มต้นเตรียมพร้อมทำงาน
  sensors.begin();
}


// ฟังก์ชัน loop() คือหัวใจของโปรแกรม จะทำงาน "วนซ้ำไปเรื่อยๆ" ไม่มีวันหยุด
void loop() {
  // 1. สั่งให้เซ็นเซอร์เริ่มวัดอุณหภูมิ
  // เราตะโกนบอกเซ็นเซอร์ว่า "เฮ้! ช่วยวัดอุณหภูมิปัจจุบันให้หน่อย"
  // คำสั่งนี้ยังไม่ได้ค่ากลับมานะ แค่สั่งให้มันเริ่มทำงานเฉยๆ
  sensors.requestTemperatures(); 
  
  // 2. เดินไปเก็บผลลัพธ์
  // เราขอค่าอุณหภูมิเป็น "องศาเซลเซียส" จากเซ็นเซอร์ตัวแรกในสาย (คำว่า ByIndex(0) หมายถึงตัวแรกสุด)
  // แล้วเก็บค่าที่ได้ไว้ในตัวแปรชื่อ tempC
  float tempC = sensors.getTempCByIndex(0);

  // 3. ตรวจสอบค่าที่ได้มาก่อนใช้งาน
  // บางทีเซ็นเซอร์อาจจะหลุดหรือเสีย มันจะส่งค่าพิเศษ (-127) กลับมา
  // เราเลยต้องเช็คก่อนว่าค่าที่ได้มาไม่ใช่ค่า error นะ
  if (tempC != DEVICE_DISCONNECTED_C) {
    // ถ้าทุกอย่างเรียบร้อยดี ก็แสดงผลอุณหภูมิที่อ่านได้
    Serial.print("Temperature: ");
    Serial.print(tempC);
    Serial.println(" °C");
    float calibrated_tempC = (alpha*tempC) + beta ;
    Serial.print("Temperature_Calibrated: ");
    Serial.print(calibrated_tempC);
    Serial.println(" °C");
  } else {
    // แต่ถ้าค่าที่ได้มันคือค่า error เราก็จะแสดงข้อความบอกปัญหาแทน
    Serial.println("Error: Could not read temperature data");
  }

  // 4. พักหายใจสักครู่
  // หน่วงเวลา 1 วินาที (1000 มิลลิวินาที) ก่อนจะเริ่มทำงานในลูปนี้อีกครั้ง
  // เพื่อไม่ให้ข้อมูลมันวิ่งเร็วเกินไปจนเราอ่านไม่ทัน
  delay(1000);
}